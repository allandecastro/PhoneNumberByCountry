"use strict";
// Copyright (C) Microsoft Corporation. All rights reserved.
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const diagnosticMessages_generated_1 = require("../diagnosticMessages.generated");
const locale_generated_1 = require("../locale.generated");
const sourcecodevalidator_1 = require("../sourcecodevalidator");
const manifestschemavalidator_1 = require("../manifestschemavalidator");
class ValidateSourceTask {
    getDescription() {
        return locale_generated_1.translate(diagnosticMessages_generated_1.strings.task_validate_control_source.key);
    }
    setOptions(options) {
        this._options = options;
    }
    run(context) {
        return context.mapControls((control) => {
            const codePath = path.resolve(control.getControlPath(), control.getCodeRelativePath());
            if (!sourcecodevalidator_1.ValidateCode(context.getDiagnostic(), codePath)) {
                return Promise.reject();
            }
            return Promise.resolve();
        });
    }
}
exports.ValidateSourceTask = ValidateSourceTask;
class ValidateManifestTask {
    getDescription() {
        return locale_generated_1.translate(diagnosticMessages_generated_1.strings.task_validate_manifest.key);
    }
    setOptions(options) {
        this._options = options;
    }
    run(context) {
        return context.mapControls((control) => {
            const validator = new manifestschemavalidator_1.ManifestSchemaValidator(control.getParsedManifest());
            const validationErrors = validator.validateManifest();
            if (validationErrors.length > 0) {
                validationErrors.forEach((err) => {
                    context.getDiagnostic().pushA(diagnosticMessages_generated_1.strings.manifest_validation_error, [err]);
                });
                return Promise.reject();
            }
            return Promise.resolve();
        });
    }
}
exports.ValidateManifestTask = ValidateManifestTask;
